<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <title>mod</title>
        <script src="mod.js" type="text/javascript" charset="utf-8"></script>
        <script src="tests/assert.js" type="text/javascript" charset="utf-8"></script>
    </head>
    <body id="index">
        <script type="text/javascript" charset="utf-8">
            var initMod = function () {
                if (mod.reset) {
                    mod.reset();
                }
                mod.modules = {
                    testSeq : ''
                };
                mod.useTagInjection = true;
                mod.expansions = {
                    URLExpansion : 'tests/outer/inner/',
                    Deepest : 'deepest/'
                };
            };    
            var onload = function () {
                initMod();
                
                var callbackCount = 0;
                
                // create the main module
                mod({
                    name : 'Main',
                    dependencies : [
                        'tests/parallel.js',
                        'tests/t1.js',
                        'URLExpansion::ExpansionTest.js', // Test the url expansion feature...
                        'URLExpansion::Deepest::DoubleExpansion.js',
                        'http://schell.github.com/go/go.js' // Test we can load external (non-module) js...
                    ],
                    init : function initMain(modules) {
                        // Is module tests
                        assert.eq(mod.isModule({
                            name : 'ismod'
                        }), false, 'Object with only name is not a module');
                        assert.eq(mod.isModule({
                            name : 'ismod',
                            dependencies : []
                        }), false, 'Object without init function is not a module');
                        assert.eq(mod.isModule({
                            name : 'ismod',
                            init : function () {}
                        }), true, 'Object with only name and init function is a module');
                        // URL expansion tests...
                        assert.eq(mod.modules.ExpansionTest, 0xBEEF, 'Can expand paths by key.');
                        assert.eq(mod.modules.DoubleExpansion, 0xFACE, 'Can expand paths by multiple keys.');
                        // Standard JS test...
                        assert.eq('go' in window, true, 'Can load external, non-module source files.');
                        return {};
                    },
                    callback : function cbMain(modules) {
                        assert.suite = 'Overall Tests';
                        callbackCount++;
                        assert.eq(callbackCount, 1, 'Callbacks are only called once (can define module in init)');
                        
                        // Whether or not we should compile or show the readme...
                        window = window || false;
                        var shouldCompile = window && (window.location.href.indexOf('file://') != -1);
                        if (shouldCompile) {
                            var compiled = mod.compile();
                            initMod();
                            assert.suite = "Compile tests";
                            eval(compiled);    
                            document.write('<pre>'+compiled+'</pre>');
                        } else {
                            readme();
                        }
                    }
                }).onload(function(m) {
                    console.log('Can execute onload after all loading.');
                    assert.stat();
                });
                
                return {};
            }();
            
            var readme = function () {
                var request = new XMLHttpRequest();
                request.open('GET', 'http://schell.github.com/mod/README.md', true);
                request.onreadystatechange = function (e) {
                    if (request.readyState === 4) {
                        if (request.status === 200 || request.status === 0) {
                            var html = '<xmp>' + request.responseText + '</xmp>';
                            document.body.innerHTML = html;
                        } else {
                            document.write('could not get readme for mod.js');
                        }
                    }
                };
                request.send(null);
            };
        </script>
    </body>
</html>